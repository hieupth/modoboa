version: '2.3'

services:
  modoboa:
    build: images/modoboa
    container_name: modoboa
    restart: on-failure
    mem_limit: 512M
    volumes:
      - type: bind
        source: "./modoboa/data"
        target: "/data"
      # Data files generated by Modoboa for the other daemons
      - type: bind
        source: "./modoboa/shared"
        target: "/shared/modoboa"
      # Dovecot Unix Domain Socket and Mail directories
      - type: bind
        source: "./dovecot/shared"
        target: "/run/dovect"
      - type: bind
        source: "./dovecot/data/mail"
        target: "/var/lib/mail"
  
  dovecot:
    image: images/dovecot
    container_name: modoboa_dovecot
    restart: on-failure
    mem_limit: 256M
    # Publish mail retrieval ports
    ports:
      - "110:110"
      - "143:143"
      - "4190:4190"
    depends_on:
      - modoboa
    volumes:
      - type: bind
        source: "./dovecot/config"
        target: "/etc/dovecot-local"
        read_only: true
      - type: bind
        source: "./dovecot/data/mail"
        target: "/var/lib/mail"
      - type: bind
        source: "./dovecot/shared"
        target: "/run/dovecot"
      # Auto-generated configuration files
      - type: bind
        source: "./modoboa/shared/dovecot"
        target: "/shared/modoboa/dovecot"
        read_only: true
      # TLS certificates:
      #  - Filename of public key:  fullchain.pem (include all intermediaries!)
      #  - Filename of private key: key.pem
      #  - You may also bind a “Let's encrypt” certificate directory here
      - type: bind
        source: "./certs"
        target: "/etc/certs"
        read_only: true

  postfix:
    image: images/postfix
    container_name: modoboa_postfix
    restart: on-failure
    mem_limit: 256M
    # Enter hostname of OS here (needed for sending a correct SMTP HELO name)
    # Unfortunately we cannot use the equivalent of `--uts=host` here since
    # there is no comparable option for docker compose files.
    hostname: ""
    # Publish mail routing ports
    ports:
      - "25:25"
      - "587:587"
    depends_on:
      - modoboa
    volumes:
      - type: bind
        source: "./postfix/config/main.cf"
        target: "/etc/postfix/main.cf"
        read_only: true
      - type: bind
        source: "./postfix/config/opendkim"
        target: "/etc/opendkim/local"
        read_only: true
      # Dovecot Unix Domain Socket directory
      - type: bind
        source: "./dovecot/shared"
        target: "/run/dovecot"
        read_only: true
      # Auto-generated configuration files
      - type: bind
        source: "./modoboa/shared/postfix"
        target: "/shared/modoboa/postfix"
        read_only: true
      - type: bind
        source: "./modoboa/shared/opendkim"
        target: "/shared/modoboa/opendkim"
        read_only: true
      # TLS certificates:
      #  - Filename of public key:  fullchain.pem (include all intermediaries!)
      #  - Filename of private key: key.pem
      #  - You may also bind a “Let's encrypt” certificate directory here
      - type: bind
        source: "./certs"
        target: "/etc/certs"
        read_only: true
